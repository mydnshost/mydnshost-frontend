name: Check Base Image

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    name: Check for base image updates

    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Registry
        uses: docker/login-action@v2
        with:
          registry: registry.shanemcc.net
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Get base image layers
        id: base
        run: |
          RAW=$(docker buildx imagetools inspect --raw \
            registry.shanemcc.net/public/docker-apache-php-base:latest)

          # Handle manifest list (multi-arch) by resolving to amd64
          if echo "$RAW" | jq -e '.manifests' > /dev/null 2>&1; then
            DIGEST=$(echo "$RAW" | jq -r '.manifests[] | select(.platform.architecture == "amd64" and .platform.os == "linux") | .digest')
            RAW=$(docker buildx imagetools inspect --raw \
              "registry.shanemcc.net/public/docker-apache-php-base@${DIGEST}")
          fi

          LAYERS=$(echo "$RAW" | jq -c '[.layers[].digest]')
          if [ -z "$LAYERS" ] || [ "$LAYERS" = "null" ] || [ "$LAYERS" = "[]" ]; then
            echo "Failed to inspect base image"
            exit 1
          fi
          echo "layers=${LAYERS}" >> "$GITHUB_OUTPUT"
          echo "count=$(echo "$LAYERS" | jq 'length')" >> "$GITHUB_OUTPUT"

      - name: Get our image layers
        id: ours
        run: |
          RAW=$(docker buildx imagetools inspect --raw \
            registry.shanemcc.net/mydnshost-public/frontend:latest 2>/dev/null || true)

          if [ -n "$RAW" ]; then
            # Handle manifest list
            if echo "$RAW" | jq -e '.manifests' > /dev/null 2>&1; then
              DIGEST=$(echo "$RAW" | jq -r '.manifests[] | select(.platform.architecture == "amd64" and .platform.os == "linux") | .digest')
              RAW=$(docker buildx imagetools inspect --raw \
                "registry.shanemcc.net/mydnshost-public/frontend@${DIGEST}" 2>/dev/null || true)
            fi
            LAYERS=$(echo "$RAW" | jq -c "[.layers[:${{ steps.base.outputs.count }}][].digest]")
          else
            LAYERS="[]"
          fi
          echo "layers=${LAYERS}" >> "$GITHUB_OUTPUT"

      - name: Trigger rebuild if base image changed
        if: steps.base.outputs.layers != steps.ours.outputs.layers
        run: gh workflow run build-and-push.yml -f trigger_source="External base image update"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
